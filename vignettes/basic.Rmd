---
title: "Basic Usage"
author: "Stephanie Zonszein"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r, include=FALSE}
#  This chunk creates the plausible but fake data for the vignette

library(igraph)
library(igraphdata)
library(interference)
data(karate)
kgraph <- as.undirected(karate)
kmat <- as_adj(kgraph, sparse=FALSE)
igraph::write_graph(kgraph, './karate_undirected.csv', format='edgelist')

outcomes <- make_dilated_out(kmat, make_corr_out, seed=0, hop=1, multipliers=NULL)
tr_vector <- make_tr_vec_permutation(nrow(kmat),0.2,R=1,seed=4224)
obs_prob_exposure <- make_exposure_prob(tr_vector, kmat, make_exposure_map_AS, list(hop=1))

exposure <- make_exposure_map_AS(kmat, tr_vector, hop=1) 

obs_outcome <- rowSums(exposure*t(outcomes))

vars <- data.frame(id=1:34, treatment=tr_vector[1,], y=obs_outcome)
fwrite(vars, './karate_vars.csv')

```

# Loading and Preparing Data

```{r}
library(interference)
library(igraph)

network <- read_graph('./karate_undirected.csv', format='edgelist', directed=FALSE)
adj_matrix <- as_adj(network, sparse=FALSE)
```

## Check the adjacency matrix

In order to use an adjacency matrix with `interference`, it must be symmetric (i.e. correspond to an undirected graph), and have all zeros on the diagonal (i.e. no self-edges).

Make sure that there are no entries different to 0 in the diagonal of the matrix.
```{r}
diag(adj_matrix)
```

Make sure that the matrix is symmetric.
```{r}
isSymmetric(adj_matrix)
```


Load the variables file, which contains the outcomes and treatment indicator:

```{r}
vars <- read.csv('./karate_vars.csv')
```


## Remove isolates

Remove isolates from the network, and from the variables data frame:
```{r}
non_isolates <- which(rowSums(adj_matrix)>0)

print(non_isolates)
print(length(non_isolates))
print(nrow(adj_matrix))

adj_matrix <- adj_matrix[non_isolates, non_isolates]
vars <- vars[vars$id %in% non_isolates,]

```

In this case, there are no isolates.

# Analysis

Compute the exposure probabilities, using the AS (Aronow-Samii) exposure mapping (p. 1930, AoAS):

```{r}
num_replicates <- 1500
prop_treated <- 0.2
N <- nrow(adj_matrix)

potential_tr_vector <- make_tr_vec_permutation(N, p=prop_treated, R=num_replicates, seed=4224)
exposure <- make_exposure_map_AS(adj_matrix, vars$treatment, hop=1) 
obs_prob_exposure <- make_exposure_prob(potential_tr_vector, adj_matrix, make_exposure_map_AS, list(hop=1))
```


```{r, message=FALSE, warning=FALSE}
my_estimates <- estimates(exposure, vars$y, obs_prob_exposure, n_var_permutations = 1000, hop=1) 
```

The return value of this function contains the values of a number of different estimators:

$\hat{\tau}_{HT}(d_{11},d_{00})$, $\hat{\tau}_{HT}(d_{10},d_{00})$, and $\hat{\tau}_{HT}(d_{01},d_{00})$, the Horvitz-Thompson estimators for each exposure condition. It also contains the variances of these estimators, as well as their constant-effects variance estimators:
```{r}
my_estimates$tau_ht
my_estimates$var_tau_ht
my_estimates$var_tau_ht_const_eff
```


$\hat{\tau}_{H}(d_{11},d_{00})$, $\hat{\tau}_{H}(d_{10},d_{00})$, and $\hat{\tau}_{H}(d_{01},d_{00})$, the corresponding HÃ¡jek estimators, and their variances:
```{r}
my_estimates$tau_h
my_estimates$var_tau_h
```